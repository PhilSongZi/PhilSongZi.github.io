<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>MYDBè®°å½•</title>
    <url>/post/7e29e8fb.html</url>
    <content><![CDATA[<h2 id="1-clone-æœ¬åœ°è¿è¡Œ">1. clone&amp;æœ¬åœ°è¿è¡Œ</h2>
<h3 id="1-1-ç¯å¢ƒ">1.1. ç¯å¢ƒ</h3>
<ul>
<li>jdkï¼š17.07</li>
<li>mavenï¼š3.9.2</li>
<li>osï¼šwindows 11</li>
</ul>
<h3 id="1-2-è¿è¡Œå‰è®¾ç½®">1.2. è¿è¡Œå‰è®¾ç½®</h3>
<ul>
<li>æ‰‹åŠ¨åˆ›å»ºæ•°æ®åº“æ–‡ä»¶å¤¹ tmp/mydbã€‚ï¼ˆåœ¨é¡¹ç›®ç›®å½•ä¸‹ã€‚ï¼‰</li>
</ul>
<h3 id="1-3-é—®é¢˜">1.3. é—®é¢˜</h3>
<ol>
<li>java.lang.ClassNotFoundException: â€œtop.guoziyang.mydb.backend.Launcherâ€</li>
</ol>
<p>è§£å†³ï¼šIDEAä¸­è®¾ç½®è¿è¡Œæ—¶å‚æ•°ã€‚<a href="https://github.com/CN-GuoZiyang/MYDB/issues/3">å‚è€ƒ</a></p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/35904594/1693275365346-6d870dfe-cdfc-4a1c-9749-28c8ac01dd72.png" alt="img"></p>
<h3 id="1-4-æ•ˆæœ">1.4 æ•ˆæœ</h3>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/35904594/1693279488747-357a38bf-7a68-4fb2-a1c8-ffaca93fccbe.png" alt="img"></p>
<h2 id="2-æ–‡æ¡£å…ˆè¡Œï¼šæ•´ä½“æ¶æ„">2. æ–‡æ¡£å…ˆè¡Œï¼šæ•´ä½“æ¶æ„</h2>
<h3 id="æ•´ä½“æ¶æ„">æ•´ä½“æ¶æ„</h3>
<h4 id="å‰ç«¯ï¼ˆå®¢æˆ·ç«¯ï¼‰">å‰ç«¯ï¼ˆå®¢æˆ·ç«¯ï¼‰</h4>
<p>è¯»å–ç”¨æˆ·è¾“å…¥ï¼Œå‘é€åˆ°åç«¯æ‰§è¡Œï¼Œè¾“å‡ºè¿”å›ç»“æœã€‚ç­‰å¾…ä¸‹ä¸€æ¬¡è¾“å…¥ã€‚</p>
<h4 id="SQLè§£æå™¨ï¼ˆåé¢è¡¥å……ï¼‰">SQLè§£æå™¨ï¼ˆåé¢è¡¥å……ï¼‰</h4>
<p>è§£æSQLï¼ŒåŒ…è£…æˆå¯¹åº”çš„å¯¹è±¡ã€‚</p>
<h4 id="åç«¯">åç«¯</h4>
<p>è§£æSQLï¼Œè‹¥åˆæ³•ï¼Œå°è¯•æ‰§è¡Œå¹¶è¿”å›ç»“æœã€‚</p>
<p>æ¨¡å—åˆ’åˆ†ï¼šå„ä¸ªæ¨¡å—é€šè¿‡æ¥å£å‘å…¶ä¾èµ–çš„æ¨¡å—æä¾›æ–¹æ³•</p>
<ol>
<li>Transaction Managerï¼ˆTMï¼‰</li>
<li>Data Managerï¼ˆDMï¼‰</li>
<li>Version Managerï¼ˆVMï¼‰</li>
<li>Index Managerï¼ˆIMï¼‰</li>
<li>Table Managerï¼ˆTBMï¼‰</li>
</ol>
<p>äº”ä¸ªæ¨¡å—çš„ä¾èµ–å›¾å¦‚ä¸‹ï¼Œæ‹“è¡¥æ’åºå¾—å‡ºå®ç°é¡ºåºä¸ºï¼šTM -&gt; DM -&gt; VM -&gt; IM -&gt; TBM</p>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/35904594/1692178246671-63ef0550-24a3-4244-bee2-0f6676035fd0.png" alt="img"></p>
<p>å„ä¸ªæ¨¡å—çš„èŒè´£ï¼š</p>
<ol>
<li>TM é€šè¿‡ç»´æŠ¤ XID æ–‡ä»¶æ¥ç»´æŠ¤äº‹åŠ¡çš„çŠ¶æ€ï¼Œå¹¶æä¾›æ¥å£ä¾›å…¶ä»–æ¨¡å—æ¥æŸ¥è¯¢æŸä¸ªäº‹åŠ¡çš„çŠ¶æ€ã€‚</li>
<li>DM ç›´æ¥ç®¡ç†æ•°æ®åº“ DB æ–‡ä»¶å’Œæ—¥å¿—æ–‡ä»¶ã€‚DM çš„ä¸»è¦èŒè´£æœ‰ï¼š1) åˆ†é¡µç®¡ç† DB æ–‡ä»¶ï¼Œå¹¶è¿›è¡Œç¼“å­˜ï¼›2) ç®¡ç†æ—¥å¿—æ–‡ä»¶ï¼Œä¿è¯åœ¨å‘ç”Ÿé”™è¯¯æ—¶å¯ä»¥æ ¹æ®æ—¥å¿—è¿›è¡Œæ¢å¤ï¼›3) æŠ½è±¡ DB æ–‡ä»¶ä¸º DataItem ä¾›ä¸Šå±‚æ¨¡å—ä½¿ç”¨ï¼Œå¹¶æä¾›ç¼“å­˜ã€‚</li>
<li>VM åŸºäºä¸¤æ®µé”åè®®å®ç°äº†è°ƒåº¦åºåˆ—çš„å¯ä¸²è¡ŒåŒ–ï¼Œå¹¶å®ç°äº† MVCC ä»¥æ¶ˆé™¤è¯»å†™é˜»å¡ã€‚åŒæ—¶å®ç°äº†ä¸¤ç§éš”ç¦»çº§åˆ«ã€‚</li>
<li>IM å®ç°äº†åŸºäº B+ æ ‘çš„ç´¢å¼•ï¼Œç›®å‰ where åªæ”¯æŒå·²ç´¢å¼•å­—æ®µã€‚</li>
<li>TBM å®ç°äº†å¯¹å­—æ®µå’Œè¡¨çš„ç®¡ç†ã€‚åŒæ—¶ï¼Œè§£æ SQL è¯­å¥ï¼Œå¹¶æ ¹æ®è¯­å¥æ“ä½œè¡¨ã€‚</li>
</ol>
<h2 id="3-Transaction-Managerï¼ˆTMï¼‰">3. Transaction Managerï¼ˆTMï¼‰</h2>
<p>TM é€šè¿‡ç»´æŠ¤ XID æ–‡ä»¶æ¥ç»´æŠ¤äº‹åŠ¡çš„çŠ¶æ€ï¼Œå¹¶æä¾›æ¥å£ä¾›å…¶ä»–æ¨¡å—æ¥æŸ¥è¯¢æŸä¸ªäº‹åŠ¡çš„çŠ¶æ€ã€‚</p>
<h3 id="XID-æ–‡ä»¶">XID  æ–‡ä»¶</h3>
<p>XID æ–‡ä»¶è§„åˆ™ï¼š</p>
<p>æ¯ä¸ªäº‹ç‰©éƒ½æœ‰ä¸€ä¸ª xidï¼Œè¿™ä¸ª ID æ˜¯ä¸€ä¸ªäº‹åŠ¡çš„<strong>å”¯ä¸€æ ‡è¯†</strong>ã€‚äº‹åŠ¡çš„ xid ä» <strong>1</strong> å¼€å§‹ç¼–å·ï¼Œè‡ªå¢ï¼Œä¸å¯é‡å¤ã€‚è§„å®š xid ä¸º 0 çš„äº‹åŠ¡æ˜¯è¶…çº§äº‹åŠ¡ï¼ˆsuper transactionï¼‰ï¼Œæƒ³åœ¨æ²¡æœ‰ç”³è¯·äº‹åŠ¡çš„æƒ…å†µä¸‹è¿›è¡Œä¸€äº›æ“ä½œæ—¶ï¼Œå¯å°†æ“ä½œçš„ xid è®¾ç½®ä¸º 0ï¼Œè¶…çº§äº‹åŠ¡çš„çŠ¶æ€ä¸€ç›´æ˜¯ committedã€‚</p>
<p>MYDB ä¸­äº‹åŠ¡çš„çŠ¶æ€ï¼š</p>
<ol>
<li>activeï¼Œè¿›è¡Œä¸­</li>
<li>committedï¼Œå·²æäº¤</li>
<li>abortedï¼Œå·²æ’¤é”€ï¼ˆå›æ»šï¼‰</li>
</ol>
<p>XID æ–‡ä»¶å†…å®¹çš„ç»“æ„ï¼š</p>
<ol>
<li>ç»™æ¯ä¸ªäº‹åŠ¡åˆ†é…<strong>ä¸€ä¸ªå­—èŠ‚</strong>çš„ç©ºé—´æ¥ä¿å­˜å…¶<strong>çŠ¶æ€</strong>ã€‚</li>
<li>XID æ–‡ä»¶å¤´éƒ¨ä¿å­˜ä¸€ä¸ª <strong>8 å­—èŠ‚æ•°å­—</strong>ï¼Œè®°å½•æ­¤ XID æ–‡ä»¶ç®¡ç†<strong>äº‹åŠ¡çš„ä¸ªæ•°</strong>ã€‚</li>
<li>äº‹åŠ¡ xid åœ¨æ–‡ä»¶ä¸­çš„çŠ¶æ€å­˜å‚¨ä½ç½®åœ¨ <strong>(xid-1)+8 å­—èŠ‚å¤„</strong>ã€‚ï¼ˆxid-1 æ˜¯å› ä¸º xid ä¸º 0 çš„çŠ¶æ€ä¸éœ€è¦è®°å½•ã€‚ï¼‰</li>
</ol>
<h3 id="TransactionManager">TransactionManager</h3>
<p>æä¾›çš„æ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TransactionManager</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="title function_">begin</span><span class="params">()</span>;                       <span class="comment">// å¼€å¯ä¸€ä¸ªæ–°äº‹åŠ¡</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">(<span class="type">long</span> xid)</span>;              <span class="comment">// æäº¤ä¸€ä¸ªäº‹åŠ¡</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">abort</span><span class="params">(<span class="type">long</span> xid)</span>;               <span class="comment">// å–æ¶ˆä¸€ä¸ªäº‹åŠ¡</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isActive</span><span class="params">(<span class="type">long</span> xid)</span>;         <span class="comment">// æŸ¥è¯¢ä¸€ä¸ªäº‹åŠ¡çš„çŠ¶æ€æ˜¯å¦æ˜¯æ­£åœ¨è¿›è¡Œçš„çŠ¶æ€</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isCommitted</span><span class="params">(<span class="type">long</span> xid)</span>;      <span class="comment">// æŸ¥è¯¢ä¸€ä¸ªäº‹åŠ¡çš„çŠ¶æ€æ˜¯å¦æ˜¯å·²æäº¤</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isAborted</span><span class="params">(<span class="type">long</span> xid)</span>;        <span class="comment">// æŸ¥è¯¢ä¸€ä¸ªäº‹åŠ¡çš„çŠ¶æ€æ˜¯å¦æ˜¯å·²å–æ¶ˆ</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span>;                       <span class="comment">// å…³é—­TM</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®å®šä¹‰çš„ XID æ–‡ä»¶ç»“æ„ï¼Œå¾—åˆ°éœ€è¦å®šä¹‰çš„ä¸€äº›å¸¸é‡ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// XIDæ–‡ä»¶å¤´é•¿åº¦</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">LEN_XID_HEADER_LENGTH</span> <span class="operator">=</span> <span class="number">8</span>;</span><br><span class="line"><span class="comment">// æ¯ä¸ªäº‹åŠ¡çš„å ç”¨é•¿åº¦</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">XID_FIELD_SIZE</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">// äº‹åŠ¡çš„ä¸‰ç§çŠ¶æ€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span> <span class="variable">FIELD_TRAN_ACTIVE</span>   <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span> <span class="variable">FIELD_TRAN_COMMITTED</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span> <span class="variable">FIELD_TRAN_ABORTED</span>  <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="comment">// è¶…çº§äº‹åŠ¡ï¼Œæ°¸è¿œä¸ºcommitedçŠ¶æ€</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">SUPER_XID</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="comment">// XID æ–‡ä»¶åç¼€</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">XID_SUFFIX</span> <span class="operator">=</span> <span class="string">&quot;.xid&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>åœ¨æ„é€ å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ª TransactionManager ä¹‹åï¼Œé¦–å…ˆè¦å¯¹ XID æ–‡ä»¶è¿›è¡Œæ ¡éªŒï¼Œä»¥ä¿è¯è¿™æ˜¯ä¸€ä¸ªåˆæ³•çš„ XID æ–‡ä»¶ã€‚æ ¡éªŒçš„æ–¹å¼æ˜¯é€šè¿‡æ–‡ä»¶å¤´çš„ 8 å­—èŠ‚æ•°å­—åæ¨æ–‡ä»¶çš„ç†è®ºé•¿åº¦ï¼Œä¸æ–‡ä»¶çš„å®é™…é•¿åº¦åšå¯¹æ¯”ã€‚å¦‚æœä¸åŒåˆ™è®¤ä¸º XID æ–‡ä»¶ä¸åˆæ³•ã€‚å½“æ ¡éªŒä¸é€šè¿‡æ—¶ï¼Œè°ƒç”¨è‡ªå®šä¹‰æ–¹æ³•å¼ºåˆ¶åœæœºã€‚</p>
<p><code>begin()</code>æ–¹æ³•ï¼šå¼€å¯ä¸€ä¸ªäº‹åŠ¡â€”â€”</p>
<ul>
<li>é¦–å…ˆè®¾ç½® xidCounter+1 äº‹åŠ¡çš„çŠ¶æ€ä¸º committedï¼Œ</li>
<li>ç„¶å xidCounter è‡ªå¢</li>
<li>åŒæ—¶ï¼Œäº‹åŠ¡æ•°é‡å¢åŠ äº†ä¸€ä¸ªï¼Œåˆ«å¿˜è®°æ›´æ–°æ–‡ä»¶å¤´ã€‚</li>
</ul>
<p><strong>æ³¨æ„ç‚¹</strong>ï¼šæ‰€æœ‰æ–‡ä»¶æ“ä½œåœ¨æ‰§è¡Œåéƒ½éœ€è¦ç«‹åˆ»åˆ·å…¥æ–‡ä»¶ä¸­ï¼Œé˜²æ­¢å´©æºƒåæ–‡ä»¶ä¸¢å¤±æ•°æ®ã€‚</p>
<p>ä»æŸ¥è¯¢äº‹åŠ¡çŠ¶æ€çš„æ–¹æ³•ä¸­æŠ½è±¡å‡ºä¸€ç§å…¬å…±çš„æ–¹æ³•ï¼Œä½¿å¾—å®ç°äº‹åŠ¡çŠ¶æ€æŸ¥è¯¢æ—¶åªéœ€æ ¹æ®æ¡ä»¶è°ƒç”¨æ­¤æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ£€æµ‹XIDäº‹åŠ¡æ˜¯å¦å¤„äºstatusçŠ¶æ€</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkXID</span><span class="params">(<span class="type">long</span> xid, <span class="type">byte</span> status)</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">offset</span> <span class="operator">=</span> getXidPosition(xid);</span><br><span class="line">    <span class="type">ByteBuffer</span> <span class="variable">buf</span> <span class="operator">=</span> ByteBuffer.wrap(<span class="keyword">new</span> <span class="title class_">byte</span>[XID_FIELD_SIZE]);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        fc.position(offset);</span><br><span class="line">        fc.read(buf);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        Panic.panic(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> buf.array()[<span class="number">0</span>] == status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨æ¥å£ TransactionManager ä¸­ï¼Œä½¿ç”¨<strong>å•ä¾‹æ¨¡å¼</strong> åˆ›å»º TMï¼Œå…¶æœ‰ä¸¤ç§æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯ï¼šå…ˆæ–°å»º XID æ–‡ä»¶å†åˆ›å»º TMå®ä¾‹ï¼ˆcreate æ–¹æ³•ï¼‰ï¼Œæˆ–è€…ä»ä¸€ä¸ªå·²æœ‰çš„ XID æ–‡ä»¶ä¸­åˆ›å»º TM å®ä¾‹ï¼ˆopen æ–¹æ³•ï¼‰ã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œä»é›¶åˆ›å»º XID æ–‡ä»¶æ—¶éœ€è¦å†™ä¸€ä¸ª<strong>ç©ºçš„ XID æ–‡ä»¶å¤´</strong>ï¼Œå³è®¾ç½® xidCounter ä¸º 0ï¼Œå¦åˆ™åç»­åœ¨æ ¡éªŒæ—¶ä¼šä¸åˆæ³•</p>
<h2 id="4-Data-Managerï¼ˆDMï¼‰">4. Data Managerï¼ˆDMï¼‰</h2>
<p>DataManagerï¼ˆDMï¼‰åŠŸèƒ½å½’çº³ï¼š</p>
<ul>
<li>ä¸Šå±‚æ¨¡å—å’Œæ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸€ä¸ªæŠ½è±¡å±‚ã€‚å‘ä¸Šï¼Œæä¾›æ•°æ®åŒ…è£…ï¼›å‘ä¸‹ï¼Œç›´æ¥è¯»å†™æ–‡ä»¶ã€‚</li>
<li>æä¾›æ—¥å¿—åŠŸèƒ½ã€‚</li>
</ul>
<h3 id="1ã€å¼•ç”¨è®¡æ•°ç¼“å­˜æ¡†æ¶">1ã€å¼•ç”¨è®¡æ•°ç¼“å­˜æ¡†æ¶</h3>
<p>åˆ†é¡µç®¡ç†å’Œæ•°æ®é¡¹ï¼ˆDataItemï¼‰ç®¡ç†æ¶‰åŠç¼“å­˜ï¼Œæ•…æŠ½è±¡å‡ºä¸€ä¸ªé€šç”¨ç¼“å­˜æ¡†æ¶ã€‚</p>
<h4 id="å¼•ç”¨è®¡æ•°æ³•">å¼•ç”¨è®¡æ•°æ³•</h4>
<p>å¼•ç”¨è®¡æ•°æ³•ï¼ˆReference countingï¼‰æ˜¯ä¸€ç§å†…å­˜ç®¡ç†æŠ€æœ¯ï¼Œå®ƒé€šè¿‡è®¡ç®—æ¯ä¸ªå¯¹è±¡è¢«å¼•ç”¨çš„æ¬¡æ•°æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦å›æ”¶è¯¥å¯¹è±¡ã€‚å½“å¯¹è±¡è¢«åˆ›å»ºæ—¶ï¼Œå¼•ç”¨è®¡æ•°ä¸º1ï¼Œæ¯å½“æœ‰ä¸€ä¸ªæ–°çš„å¼•ç”¨æŒ‡å‘è¯¥å¯¹è±¡æ—¶ï¼Œè®¡æ•°åŠ 1ï¼Œå½“å¼•ç”¨å¤±æ•ˆæ—¶ï¼Œè®¡æ•°å‡1ã€‚å½“è®¡æ•°ä¸º0æ—¶ï¼Œè¯¥å¯¹è±¡å°±å¯ä»¥è¢«å›æ”¶ã€‚</p>
<p>åœ¨MYDBçš„å®è·µä¸­ï¼Œéœ€è¦çš„æ•ˆæœæ˜¯ï¼Œåªæœ‰ä¸Šå±‚æ¨¡å—ä¸»åŠ¨é‡Šæ”¾å¼•ç”¨ï¼Œç¼“å­˜åœ¨ç¡®ä¿æ²¡æœ‰æ¨¡å—åœ¨ä½¿ç”¨è¿™ä¸ªèµ„æºäº†ï¼Œæ‰ä¼šå»é©±é€èµ„æºã€‚</p>
<p>äºæ˜¯ï¼Œé€‰æ‹©å¼•ç”¨è®¡æ•°æ³•ã€‚å¢åŠ äº†ä¸€ä¸ªæ–¹æ³• release(key)ï¼Œç”¨äºåœ¨ä¸Šå†Œæ¨¡å—ä¸ä½¿ç”¨æŸä¸ªèµ„æºæ—¶ï¼Œé‡Šæ”¾å¯¹èµ„æºçš„å¼•ç”¨ã€‚å½“å¼•ç”¨å½’é›¶æ—¶ï¼Œç¼“å­˜å°±ä¼šé©±é€è¿™ä¸ªèµ„æºã€‚</p>
<p>åŒæ ·ï¼Œåœ¨ç¼“å­˜æ»¡äº†ä¹‹åï¼Œå¼•ç”¨è®¡æ•°æ³•æ— æ³•è‡ªåŠ¨é‡Šæ”¾ç¼“å­˜ï¼Œæ­¤æ—¶åº”è¯¥ç›´æ¥æŠ¥é”™ï¼ˆå’Œ JVM ä¼¼çš„ï¼Œç›´æ¥ OOMï¼‰ã€‚</p>
<h4 id="LRU">LRU</h4>
<p>LRUï¼ˆleast recently usedï¼‰æ˜¯ä¸€ç§ç¼“å­˜æ·˜æ±°ç®—æ³•ã€‚å®ƒçš„ç‰¹ç‚¹æ˜¯æ ¹æ®æ•°æ®æœ€è¿‘è¢«è®¿é—®çš„æ—¶é—´æ¥å†³å®šå“ªäº›æ•°æ®åº”è¯¥è¢«ä¿ç•™ï¼Œå“ªäº›æ•°æ®åº”è¯¥è¢«æ·˜æ±°ã€‚å½“ç¼“å­˜è¾¾åˆ°ä¸€å®šå®¹é‡æ—¶ï¼Œä¼šæ·˜æ±°æ‰æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®ã€‚</p>
<p>å¦‚æœä½¿ç”¨ LRU ç¼“å­˜ï¼Œé‚£ä¹ˆåªéœ€è¦è®¾è®¡ä¸€ä¸ª get(key) æ¥å£å³å¯ï¼Œé‡Šæ”¾ç¼“å­˜å¯ä»¥åœ¨ç¼“å­˜æ»¡äº†ä¹‹åè‡ªåŠ¨å®Œæˆã€‚</p>
<p>howeverï¼Œå½“æŸæ—¶åˆ»ç¼“å­˜æ»¡äº†ï¼Œç¼“å­˜é©±é€ä¸€ä¸ªèµ„æºï¼Œæ­¤æ—¶ä¸Šå±‚æ¨¡å—æƒ³å°†æŸä¸ªèµ„æºå¼ºåˆ¶åˆ·å›3æ•°æ®æºï¼Œè¿™ä¸ªèµ„æºæ°æ°æ˜¯åˆšè¢«é©±é€çš„èµ„æºã€‚æ­¤æ—¶çš„ä¸Šå±‚æ¨¡å—ä¼šå‘ç°ï¼Œèµ„æºåœ¨ç¼“å­˜ä¸­æ¶ˆå¤±äº†ï¼Œé‚£ä¹ˆï¼Œæ˜¯å¦æœ‰å¿…è¦åšå›æºæ“ä½œï¼Ÿ</p>
<ul>
<li>ä¸å›æºã€‚ç”±äºæ²¡æ³•ç¡®å®šç¼“å­˜è¢«é©±é€çš„æ—¶é—´ï¼Œæ›´æ²¡æ³•ç¡®å®šè¢«é©±é€ä¹‹åæ•°æ®é¡¹æ˜¯å¦è¢«ä¿®æ”¹ï¼Œè¿™æ ·æ˜¯æå…¶ä¸å®‰å…¨çš„</li>
<li>å›æºã€‚å¦‚æœæ•°æ®é¡¹è¢«é©±é€æ—¶çš„æ•°æ®å’Œç°åœ¨åˆæ˜¯ç›¸åŒçš„ï¼Œé‚£å°±æ˜¯ä¸€æ¬¡æ— æ•ˆå›æº</li>
<li>æ”¾å›ç¼“å­˜é‡Œï¼Œç­‰ä¸‹æ¬¡è¢«é©±é€æ—¶å›æºã€‚çœ‹èµ·æ¥è§£å†³äº†é—®é¢˜ï¼Œä½†æ˜¯æ­¤æ—¶ç¼“å­˜å·²ç»æ»¡äº†ï¼Œè¿™æ„å‘³ç€ä½ è¿˜éœ€è¦é©±é€ä¸€ä¸ªèµ„æºæ‰èƒ½æ”¾è¿›å»ã€‚è¿™æœ‰å¯èƒ½ä¼šå¯¼è‡´ç¼“å­˜æŠ–åŠ¨é—®é¢˜ã€‚</li>
</ul>
<h4 id="å®ç°">å®ç°</h4>
<p><code>AbstractCache</code>ç±»ä½œä¸ºæŠ½è±¡ç¼“å­˜ç±»ï¼Œå®šä¹‰ä¸¤ä¸ªæ–¹æ³•äº¤ç”±å­ç±»å®ç°ã€‚</p>
<p>å®ç°å¼•ç”¨è®¡æ•°ï¼Œéœ€è¦ç»´æŠ¤ä¸€ä¸ªèµ„æºå¼•ç”¨ä¸ªæ•°çš„HashMapï¼Œä¸ºäº†å¤šçº¿ç¨‹è®¿é—®ï¼Œéœ€è¦ç»´æŠ¤ä¸€ä¸ªè®°å½•èµ„æºè®¿é—®æƒ…å†µçš„HashMapã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å½“èµ„æºä¸åœ¨ç¼“å­˜æ—¶çš„è·å–è¡Œä¸º</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> T <span class="title function_">getForCache</span><span class="params">(<span class="type">long</span> key)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å½“èµ„æºè¢«é©±é€æ—¶çš„å†™å›è¡Œä¸º</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">releaseForCache</span><span class="params">(T obj)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> HashMap&lt;Long, T&gt; cache;                     <span class="comment">// å®é™…ç¼“å­˜çš„æ•°æ®</span></span><br><span class="line"><span class="keyword">private</span> HashMap&lt;Long, Integer&gt; references;          <span class="comment">// èµ„æºçš„å¼•ç”¨ä¸ªæ•°</span></span><br><span class="line"><span class="keyword">private</span> HashMap&lt;Long, Boolean&gt; getting;             <span class="comment">// æ­£åœ¨è¢«è·å–çš„èµ„æº</span></span><br></pre></td></tr></table></figure>
<p>è·å–èµ„æºçš„<code>get()</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> T <span class="title function_">get</span><span class="params">(<span class="type">long</span> key)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1.åœ¨é€šè¿‡ get() æ–¹æ³•è·å–èµ„æºæ—¶ï¼Œé¦–å…ˆè¿›å…¥ä¸€ä¸ªæ­»å¾ªç¯ï¼Œæ¥æ— é™å°è¯•ä»ç¼“å­˜é‡Œè·å–ã€‚</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="comment">// 1.1.é¦–å…ˆå°±éœ€è¦æ£€æŸ¥è¿™ä¸ªæ—¶å€™æ˜¯å¦æœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨ä»æ•°æ®æºè·å–è¿™ä¸ªèµ„æºï¼Œå¦‚æœæœ‰ï¼Œå°±è¿‡ä¼šå†æ¥çœ‹çœ‹</span></span><br><span class="line">            <span class="keyword">if</span>(getting.containsKey(key)) &#123;</span><br><span class="line">                <span class="comment">// è¯·æ±‚çš„èµ„æºæ­£åœ¨è¢«å…¶ä»–çº¿ç¨‹è·å–</span></span><br><span class="line">                lock.unlock();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 1.2.å¦‚æœæ²¡æœ‰å…¶ä»–çº¿ç¨‹åœ¨è·å–è¿™ä¸ªèµ„æºï¼Œé‚£ä¹ˆå°±å¯ä»¥å°è¯•ä»ç¼“å­˜ä¸­è·å–äº†</span></span><br><span class="line">            <span class="keyword">if</span>(cache.containsKey(key)) &#123;</span><br><span class="line">                <span class="comment">// èµ„æºåœ¨ç¼“å­˜ä¸­ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">                <span class="type">T</span> <span class="variable">obj</span> <span class="operator">=</span> cache.get(key);</span><br><span class="line">                <span class="comment">// è®°å¾—ç»™èµ„æºçš„å¼•ç”¨è®¡æ•°åŠ ä¸€</span></span><br><span class="line">                references.put(key, references.get(key) + <span class="number">1</span>);</span><br><span class="line">                lock.unlock();</span><br><span class="line">                <span class="keyword">return</span> obj;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 1.3.å°è¯•è·å–è¯¥èµ„æº</span></span><br><span class="line">            <span class="comment">// a.åˆ¤æ–­ç¼“å­˜æ˜¯å¦å·²æ»¡ï¼Œå¦‚æœå·²æ»¡ï¼Œå°±æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸</span></span><br><span class="line">            <span class="keyword">if</span>(maxResource &gt; <span class="number">0</span> &amp;&amp; count == maxResource) &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">                <span class="keyword">throw</span> Error.CacheFullException;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// b.å¦‚æœç¼“å­˜æœªæ»¡ï¼Œå°±åœ¨ getting ä¸­æ³¨å†Œä¸€ä¸‹ï¼Œè¯¥çº¿ç¨‹å‡†å¤‡ä»æ•°æ®æºè·å–èµ„æºäº†</span></span><br><span class="line">            count ++;</span><br><span class="line">            getting.put(key, <span class="literal">true</span>);</span><br><span class="line">            lock.unlock();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.ä»æ•°æ®æºè·å–èµ„æº</span></span><br><span class="line">        <span class="type">T</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            obj = getForCache(key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœè·å–å¤±è´¥ï¼Œå°±æŠŠ getting ä¸­çš„æ³¨å†Œä¿¡æ¯æ¸…é™¤æ‰</span></span><br><span class="line">            lock.lock();</span><br><span class="line">            count --;</span><br><span class="line">            getting.remove(key);</span><br><span class="line">            lock.unlock();</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lock.lock();</span><br><span class="line">        getting.remove(key);       <span class="comment">// è·å–å®Œæˆè¦ä» getting ä¸­æ¸…é™¤æ³¨å†Œä¿¡æ¯</span></span><br><span class="line">        cache.put(key, obj);</span><br><span class="line">        references.put(key, <span class="number">1</span>);</span><br><span class="line">        lock.unlock();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>é‡Šæ”¾èµ„æºçš„<code>release</code>æ–¹æ³•ï¼šå½“å¼•ç”¨è®¡æ•°references é€æ¸ -1 å‡åˆ° 0 åï¼Œå°±å¯ä»¥å›æºå¹¶åˆ é™¤ç¼“å­˜ä¸­ç›¸å…³çš„ç»“æ„ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 3.é‡Šæ”¾èµ„æº</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">release</span><span class="params">(<span class="type">long</span> key)</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// é‡Šæ”¾ä¸€ä¸ªç¼“å­˜æ—¶ï¼Œç›´æ¥ä» references ä¸­å‡ 1ï¼Œå¦‚æœå·²ç»å‡åˆ° 0 äº†ï¼Œå°±å¯ä»¥å›æºï¼Œå¹¶ä¸”åˆ é™¤ç¼“å­˜ä¸­æ‰€æœ‰ç›¸å…³çš„ç»“æ„</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">ref</span> <span class="operator">=</span> references.get(key) - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span>(ref == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="type">T</span> <span class="variable">obj</span> <span class="operator">=</span> cache.get(key);</span><br><span class="line">                <span class="comment">// è°ƒç”¨æŠ½è±¡æ–¹æ³•é‡Šæ”¾ç¼“å­˜</span></span><br><span class="line">                releaseForCache(obj);</span><br><span class="line">                <span class="comment">// åˆ é™¤ç¼“å­˜ä¸­æ‰€æœ‰ç›¸å…³çš„ç»“æ„</span></span><br><span class="line">                references.remove(key);</span><br><span class="line">                cache.remove(key);</span><br><span class="line">                count --;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                references.put(key, ref);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="2ã€å…±äº«å†…å­˜æ•°ç»„">2ã€å…±äº«å†…å­˜æ•°ç»„</h3>
<p>åœ¨Javaä¸­ï¼Œ<strong>æ•°ç»„</strong>è¢«è§†ä¸ºä¸€ä¸ª<strong>å¯¹è±¡</strong>ï¼Œå…¶åœ¨å†…å­˜ä¸­ä¹Ÿæ˜¯ä»¥å¯¹è±¡çš„å½¢å¼å­˜å‚¨çš„ã€‚åœ¨ Java ä¸­ï¼Œå½“æ‰§è¡Œç±»ä¼¼ subArray çš„æ“ä½œæ—¶ï¼Œåªä¼šåœ¨åº•å±‚è¿›è¡Œä¸€ä¸ªå¤åˆ¶ï¼Œ<strong>æ— æ³•åŒä¸€ç‰‡å†…å­˜</strong>ã€‚æ‰€ä»¥ï¼Œè¦å®ç°å…±äº«å†…å­˜æ•°ç»„ï¼Œå®šä¹‰ä¸€ä¸ª<code>SubArray</code>ç±»ï¼Œè§„å®šè¿™ä¸ªæ•°ç»„çš„å¯ä½¿ç”¨èŒƒå›´ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubArray</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] raw;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> start;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> end;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SubArray</span><span class="params">(<span class="type">byte</span>[] raw, <span class="type">int</span> start, <span class="type">int</span> end)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.raw = raw;</span><br><span class="line">        <span class="built_in">this</span>.start = start;</span><br><span class="line">        <span class="built_in">this</span>.end = end;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3ã€æ•°æ®é¡µçš„ç¼“å­˜ä¸ç®¡ç†">3ã€æ•°æ®é¡µçš„ç¼“å­˜ä¸ç®¡ç†</h3>
<h4 id="é¡µé¢ç¼“å­˜">é¡µé¢ç¼“å­˜</h4>
<p>é»˜è®¤æ•°æ®é¡µå¤§å°å®šä¸º 8Kï¼Œé¦–å…ˆï¼Œéœ€è¦å®šä¹‰å‡ºé¡µé¢çš„ç»“æ„ã€‚æ³¨æ„è¿™ä¸ªé¡µé¢æ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ï¼Œä¸å·²ç»æŒä¹…åŒ–åˆ°ç£ç›˜çš„æŠ½è±¡é¡µé¢æœ‰åŒºåˆ«ã€‚</p>
<p>å®šä¹‰ä¸€ä¸ªé¡µé¢å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PageImpl</span> <span class="keyword">implements</span> <span class="title class_">Page</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> pageNumber;  <span class="comment">// é¡µå·ï¼Œä»1å¼€å§‹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">byte</span>[] data;  <span class="comment">// æ­¤é¡µé¢å®é™…åŒ…å«çš„å­—èŠ‚æ•°æ®</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> dirty;  <span class="comment">// æ ‡è¯†æ˜¯å¦æ˜¯è„é¡µé¢ã€‚ç¼“å­˜é©±é€æ—¶ï¼Œè„é¡µé¢éœ€è¦è¢«å†™å›ç£ç›˜</span></span><br><span class="line">    <span class="keyword">private</span> Lock lock;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// ä¿å­˜äº†ä¸€ä¸ª PageCache çš„å¼•ç”¨ï¼Œæ–¹ä¾¿åœ¨æ‹¿åˆ° Page çš„å¼•ç”¨æ—¶å¯ä»¥å¿«é€Ÿå¯¹è¿™ä¸ªé¡µé¢çš„ç¼“å­˜è¿›è¡Œé‡Šæ”¾æ“ä½œã€‚</span></span><br><span class="line">    <span class="keyword">private</span> PageCache pc;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¡µé¢ç¼“å­˜æ¥å£ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PageCache</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">newPage</span><span class="params">(<span class="type">byte</span>[] initData)</span>;</span><br><span class="line">    Page <span class="title function_">getPage</span><span class="params">(<span class="type">int</span> pgno)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">release</span><span class="params">(Page page)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">truncateByBgno</span><span class="params">(<span class="type">int</span> maxPgno)</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">getPageNumber</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">flushPage</span><span class="params">(Page pg)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¡µé¢ç¼“å­˜çš„å…·ä½“å®ç°ç±»ï¼Œéœ€è¦ç»§æ‰¿æŠ½è±¡ç¼“å­˜æ¡†æ¶ï¼Œå¹¶ä¸”å®ç° <code>getForCache() </code>å’Œ <code>releaseForCache() </code>ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•ã€‚ç”±äºæ•°æ®æºå°±æ˜¯æ–‡ä»¶ç³»ç»Ÿï¼Œ<code>getForCache() </code>ç›´æ¥ä»æ–‡ä»¶ä¸­è¯»å–ï¼Œå¹¶åŒ…è£¹æˆ Page å³å¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> Page <span class="title function_">getForCache</span><span class="params">(<span class="type">long</span> key)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">pgno</span> <span class="operator">=</span> (<span class="type">int</span>)key;</span><br><span class="line">    <span class="type">long</span> <span class="variable">offset</span> <span class="operator">=</span> PageCacheImpl.pageOffset(pgno);</span><br><span class="line"></span><br><span class="line">    <span class="type">ByteBuffer</span> <span class="variable">buf</span> <span class="operator">=</span> ByteBuffer.allocate(PAGE_SIZE);</span><br><span class="line">    fileLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        fc.position(offset);</span><br><span class="line">        fc.read(buf);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(IOException e) &#123;</span><br><span class="line">        Panic.panic(e);</span><br><span class="line">    &#125;</span><br><span class="line">    fileLock.unlock();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageImpl</span>(pgno, buf.array(), <span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">pageOffset</span><span class="params">(<span class="type">int</span> pgno)</span> &#123;</span><br><span class="line">    <span class="comment">// é¡µå·ä» 1 å¼€å§‹</span></span><br><span class="line">    <span class="keyword">return</span> (pgno-<span class="number">1</span>) * PAGE_SIZE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è€Œ releaseForCache() é©±é€é¡µé¢æ—¶ï¼Œä¹Ÿåªéœ€è¦æ ¹æ®é¡µé¢æ˜¯å¦æ˜¯è„é¡µé¢ï¼Œæ¥å†³å®šæ˜¯å¦éœ€è¦å†™å›æ–‡ä»¶ç³»ç»Ÿï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">releaseForCache</span><span class="params">(Page pg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(pg.isDirty()) &#123;</span><br><span class="line">        flush(pg);</span><br><span class="line">        pg.setDirty(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">flush</span><span class="params">(Page pg)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">pgno</span> <span class="operator">=</span> pg.getPageNumber();</span><br><span class="line">    <span class="type">long</span> <span class="variable">offset</span> <span class="operator">=</span> pageOffset(pgno);</span><br><span class="line"></span><br><span class="line">    fileLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">buf</span> <span class="operator">=</span> ByteBuffer.wrap(pg.getData());</span><br><span class="line">        fc.position(offset);</span><br><span class="line">        fc.write(buf);</span><br><span class="line">        fc.force(<span class="literal">false</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(IOException e) &#123;</span><br><span class="line">        Panic.panic(e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        fileLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PageCache è¿˜ä½¿ç”¨äº†ä¸€ä¸ª AtomicIntegerï¼Œæ¥è®°å½•äº†å½“å‰æ‰“å¼€çš„æ•°æ®åº“æ–‡ä»¶æœ‰å¤šå°‘é¡µã€‚è¿™ä¸ªæ•°å­—åœ¨æ•°æ®åº“æ–‡ä»¶è¢«æ‰“å¼€æ—¶å°±ä¼šè¢«è®¡ç®—ï¼Œå¹¶åœ¨æ–°å»ºé¡µé¢æ—¶è‡ªå¢ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">newPage</span><span class="params">(<span class="type">byte</span>[] initData)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">pgno</span> <span class="operator">=</span> pageNumbers.incrementAndGet();</span><br><span class="line">    <span class="type">Page</span> <span class="variable">pg</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PageImpl</span>(pgno, initData, <span class="literal">null</span>);</span><br><span class="line">    flush(pg);  <span class="comment">// æ–°å»ºçš„é¡µé¢éœ€è¦ç«‹åˆ»å†™å›</span></span><br><span class="line">    <span class="keyword">return</span> pgno;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="æ•°æ®é¡µç®¡ç†">æ•°æ®é¡µç®¡ç†</h4>
<p><strong>ç¬¬ä¸€é¡µ</strong>ï¼š</p>
<p>æ•°æ®åº“æ–‡ä»¶çš„ç¬¬ä¸€é¡µï¼Œé€šå¸¸ç”¨ä½œä¸€äº›ç‰¹æ®Šç”¨é€”ï¼Œæ¯”å¦‚å­˜å‚¨ä¸€äº›å…ƒæ•°æ®ï¼Œç”¨æ¥å¯åŠ¨æ£€æŸ¥ä»€ä¹ˆçš„ã€‚MYDB çš„ç¬¬ä¸€é¡µï¼Œåªæ˜¯ç”¨æ¥åšå¯åŠ¨æ£€æŸ¥ã€‚å…·ä½“çš„åŸç†æ˜¯ï¼Œåœ¨æ¯æ¬¡æ•°æ®åº“å¯åŠ¨æ—¶ï¼Œä¼šç”Ÿæˆä¸€ä¸²éšæœºå­—èŠ‚ï¼Œå­˜å‚¨åœ¨ 100 ~ 107 å­—èŠ‚ã€‚åœ¨æ•°æ®åº“æ­£å¸¸å…³é—­æ—¶ï¼Œä¼šå°†è¿™ä¸²å­—èŠ‚ï¼Œæ‹·è´åˆ°ç¬¬ä¸€é¡µçš„ 108 ~ 115 å­—èŠ‚ã€‚</p>
<p>è¿™æ ·æ•°æ®åº“åœ¨æ¯æ¬¡å¯åŠ¨æ—¶ï¼Œå°±ä¼šæ£€æŸ¥ç¬¬ä¸€é¡µä¸¤å¤„çš„å­—èŠ‚æ˜¯å¦ç›¸åŒï¼Œä»¥æ­¤æ¥åˆ¤æ–­ä¸Šä¸€æ¬¡æ˜¯å¦æ­£å¸¸å…³é—­ã€‚å¦‚æœæ˜¯å¼‚å¸¸å…³é—­ï¼Œå°±éœ€è¦æ‰§è¡Œæ•°æ®çš„æ¢å¤æµç¨‹ã€‚</p>
<p>å¯åŠ¨æ—¶è®¾ç½®åˆå§‹å­—èŠ‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setVcOpen</span><span class="params">(Page pg)</span> &#123;</span><br><span class="line">    pg.setDirty(<span class="literal">true</span>);</span><br><span class="line">    setVcOpen(pg.getData());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setVcOpen</span><span class="params">(<span class="type">byte</span>[] raw)</span> &#123;</span><br><span class="line">    System.arraycopy(RandomUtil.randomBytes(LEN_VC), <span class="number">0</span>, raw, OF_VC, LEN_VC);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…³é—­æ—¶æ‹·è´å­—èŠ‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setVcClose</span><span class="params">(Page pg)</span> &#123;</span><br><span class="line">    pg.setDirty(<span class="literal">true</span>);</span><br><span class="line">    setVcClose(pg.getData());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setVcClose</span><span class="params">(<span class="type">byte</span>[] raw)</span> &#123;</span><br><span class="line">    System.arraycopy(raw, OF_VC, raw, OF_VC+LEN_VC, LEN_VC);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ¡éªŒå­—èŠ‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkVc</span><span class="params">(Page pg)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> checkVc(pg.getData());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkVc</span><span class="params">(<span class="type">byte</span>[] raw)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Arrays.equals(Arrays.copyOfRange(raw, OF_VC, OF_VC+LEN_VC), Arrays.copyOfRange(raw, OF_VC+LEN_VC, OF_VC+<span class="number">2</span>*LEN_VC));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ™®é€šé¡µ</strong>ï¼š</p>
<p>ä¸€ä¸ªæ™®é€šé¡µé¢ä»¥ä¸€ä¸ª 2 å­—èŠ‚æ— ç¬¦å·æ•°èµ·å§‹ï¼Œè¡¨ç¤ºè¿™ä¸€é¡µçš„ç©ºé—²ä½ç½®çš„åç§»ã€‚å‰©ä¸‹çš„éƒ¨åˆ†éƒ½æ˜¯å®é™…å­˜å‚¨çš„æ•°æ®ã€‚</p>
<p>æ‰€ä»¥å¯¹æ™®é€šé¡µçš„ç®¡ç†ï¼ŒåŸºæœ¬éƒ½æ˜¯å›´ç»•ç€å¯¹ FSOï¼ˆFree Space Offsetï¼‰è¿›è¡Œçš„ã€‚</p>
<p>ä¾‹å¦‚å‘é¡µé¢æ’å…¥æ•°æ®ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å°†rawæ’å…¥pgä¸­ï¼Œè¿”å›æ’å…¥ä½ç½®</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">short</span> <span class="title function_">insert</span><span class="params">(Page pg, <span class="type">byte</span>[] raw)</span> &#123;</span><br><span class="line">    pg.setDirty(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">short</span> <span class="variable">offset</span> <span class="operator">=</span> getFSO(pg.getData());</span><br><span class="line">    System.arraycopy(raw, <span class="number">0</span>, pg.getData(), offset, raw.length);</span><br><span class="line">    setFSO(pg.getData(), (<span class="type">short</span>)(offset + raw.length));</span><br><span class="line">    <span class="keyword">return</span> offset;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨å†™å…¥ä¹‹å‰è·å– FSOï¼Œæ¥ç¡®å®šå†™å…¥çš„ä½ç½®ï¼Œå¹¶åœ¨å†™å…¥ä¹‹åæ›´æ–° FSOã€‚FSO çš„æ“ä½œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFSO</span><span class="params">(<span class="type">byte</span>[] raw, <span class="type">short</span> ofData)</span> &#123;</span><br><span class="line">    System.arraycopy(Parser.short2Byte(ofData), <span class="number">0</span>, raw, OF_FREE, OF_DATA);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–pgçš„FSO</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">short</span> <span class="title function_">getFSO</span><span class="params">(Page pg)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> getFSO(pg.getData());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">short</span> <span class="title function_">getFSO</span><span class="params">(<span class="type">byte</span>[] raw)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Parser.parseShort(Arrays.copyOfRange(raw, <span class="number">0</span>, <span class="number">2</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–é¡µé¢çš„ç©ºé—²ç©ºé—´å¤§å°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getFreeSpace</span><span class="params">(Page pg)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> PageCache.PAGE_SIZE - (<span class="type">int</span>)getFSO(pg.getData());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‰©ä½™ä¸¤ä¸ªå‡½æ•° recoverInsert() å’Œ recoverUpdate() ç”¨äºåœ¨æ•°æ®åº“å´©æºƒåé‡æ–°æ‰“å¼€æ—¶ï¼Œæ¢å¤ä¾‹ç¨‹ç›´æ¥æ’å…¥æ•°æ®ä»¥åŠä¿®æ”¹æ•°æ®ä½¿ç”¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å°†rawæ’å…¥pgä¸­çš„offsetä½ç½®ï¼Œå¹¶å°†pgçš„offsetè®¾ç½®ä¸ºè¾ƒå¤§çš„offset</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">recoverInsert</span><span class="params">(Page pg, <span class="type">byte</span>[] raw, <span class="type">short</span> offset)</span> &#123;</span><br><span class="line">    pg.setDirty(<span class="literal">true</span>);</span><br><span class="line">    System.arraycopy(raw, <span class="number">0</span>, pg.getData(), offset, raw.length);</span><br><span class="line"></span><br><span class="line">    <span class="type">short</span> <span class="variable">rawFSO</span> <span class="operator">=</span> getFSO(pg.getData());</span><br><span class="line">    <span class="keyword">if</span>(rawFSO &lt; offset + raw.length) &#123;</span><br><span class="line">        setFSO(pg.getData(), (<span class="type">short</span>)(offset+raw.length));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†rawæ’å…¥pgä¸­çš„offsetä½ç½®ï¼Œä¸æ›´æ–°update</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">recoverUpdate</span><span class="params">(Page pg, <span class="type">byte</span>[] raw, <span class="type">short</span> offset)</span> &#123;</span><br><span class="line">    pg.setDirty(<span class="literal">true</span>);</span><br><span class="line">    System.arraycopy(raw, <span class="number">0</span>, pg.getData(), offset, raw.length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-Version-Managerï¼ˆVMï¼‰">5. Version Managerï¼ˆVMï¼‰</h2>
<h2 id="6-Index-Manager-ï¼ˆIMï¼‰">6. Index Manager ï¼ˆIMï¼‰</h2>
<h2 id="7-Table-Managerï¼ˆTBMï¼‰">7. Table Managerï¼ˆTBMï¼‰</h2>
<h2 id="8-SQLè¯æ³•è§£æå™¨">8. SQLè¯æ³•è§£æå™¨</h2>
<h2 id="9-Server-å’Œ-Client">9. Server å’Œ Client</h2>
<h2 id="10-æ€»ç»“ï¼ˆä»å®ç°åŠŸèƒ½å‡ºå‘ï¼Œç”±ç‚¹åˆ°é¢é€æ¸æ€»ç»“å¯¹åº”çš„MySQLï¼‰">10. æ€»ç»“ï¼ˆä»å®ç°åŠŸèƒ½å‡ºå‘ï¼Œç”±ç‚¹åˆ°é¢é€æ¸æ€»ç»“å¯¹åº”çš„MySQLï¼‰</h2>
<h3 id="å®ç°çš„åŠŸèƒ½">å®ç°çš„åŠŸèƒ½</h3>
<h4 id="æ•°æ®çš„å¯é æ€§å’Œæ•°æ®æ¢å¤">æ•°æ®çš„å¯é æ€§å’Œæ•°æ®æ¢å¤</h4>
<h4 id="ä¸¤æ®µé”åè®®ï¼ˆ2PLï¼‰å®ç°å¯ä¸²è¡ŒåŒ–è°ƒåº¦">ä¸¤æ®µé”åè®®ï¼ˆ2PLï¼‰å®ç°å¯ä¸²è¡ŒåŒ–è°ƒåº¦</h4>
<h4 id="MVCC">MVCC</h4>
<h4 id="ä¸¤ç§äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼ˆè¯»æäº¤å’Œå¯é‡å¤è¯»ï¼‰">ä¸¤ç§äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼ˆè¯»æäº¤å’Œå¯é‡å¤è¯»ï¼‰</h4>
<h4 id="æ­»é”å¤„ç†">æ­»é”å¤„ç†</h4>
<h4 id="ç®€å•çš„è¡¨å’Œå­—æ®µç®¡ç†">ç®€å•çš„è¡¨å’Œå­—æ®µç®¡ç†</h4>
<h4 id="ç®€å•çš„-SQL-è§£æ">ç®€å•çš„ SQL è§£æ</h4>
<h4 id="åŸºäº-socket-çš„-server-å’Œ-client">åŸºäº socket çš„ server å’Œ client</h4>
]]></content>
      <categories>
        <category>Coding</category>
      </categories>
      <tags>
        <tag>MYDB</tag>
        <tag>è½®å­</tag>
      </tags>
  </entry>
  <entry>
    <title>Wetab</title>
    <url>/post/32e2265d.html</url>
    <content><![CDATA[<blockquote>
<p>Wetabç¬”è®°ï¼Œç»™ä½ æ›´å¥½çš„ç¬”è®°ä½“éªŒ</p>
<p>è¿™é‡Œæ˜¯<a href="https://www.wetab.link">Wetabæ–°æ ‡ç­¾å®˜ç½‘</a> (å³é”®ç‚¹å‡»æ‰“å¼€é“¾æ¥)</p>
</blockquote>
<p>ä»¥ä¸‹ç‰¹æ€§å¯ä»¥ä¸ºä½ çš„ç¬”è®°å¸¦æ¥éå¸¸æ£’çš„ä½“éªŒï¼š</p>
<ul>
<li>
<p>[x] ğŸ“ <strong>æ‰€è§å³æ‰€å¾—çš„ Markdown</strong> - ä»¥ä¸€ç§ä¼˜é›…çš„æ–¹å¼ç¼–å†™ markdown</p>
</li>
<li>
<p>[x] ğŸ‘ <strong>Emoji</strong> - æ”¯æŒ emoji å¿«æ·æŒ‡ä»¤å’Œé€‰æ‹©å™¨</p>
</li>
<li>
<p>[x] ğŸ’¾ <strong>å‰ªè´´æ¿</strong> - æ”¯æŒ markdown æ ¼å¼çš„å¤åˆ¶ç²˜è´´</p>
</li>
<li>
<p>[x] âŒ¨ï¸ <strong>æ¢è¡Œæ¨¡å¼</strong> - ä½ å¯ä»¥ä½¿ç”¨â€œEnterâ€å’Œâ€œShift + Enterâ€ä¸¤ç§æ–¹å¼è¿›è¡Œæ¢è¡Œ</p>
</li>
<li>
<p>[x] âš¡ <strong>æ–œçº¿æŒ‡ä»¤</strong> - åœ¨ç©ºç™½å¤„è¾“å…¥çŠ¶æ€ä¸‹é€šè¿‡â€œ/â€å¯ä»¥å®Œæˆä¸°å¯Œçš„è¾“å…¥æŒ‡ä»¤</p>
</li>
<li>
<p>[x] ğŸ§® <strong>æ•°å­¦æ”¯æŒ</strong> - ä½ å¯ä»¥å®Œæˆæ•°å­¦å…¬å¼çš„æå†™</p>
</li>
<li>
<p>[x] ğŸ“Š <strong>è¡¨æ ¼æ”¯æŒ</strong> - æ‹¥æœ‰æµç•…çš„ ui çš„è¡¨æ ¼æ”¯æŒ</p>
</li>
<li>
<p>[x] ğŸ“° <strong>å›¾è¡¨æ”¯æŒ</strong> - åŸºäº<a href="https://mermaid-js.github.io/mermaid/#/">mermaid</a>çš„å›¾è¡¨æ”¯æŒ</p>
</li>
</ul>
<hr>
<p>ä½ å¯ä»¥æ·»åŠ è¡Œå†…ä»£ç ä¾‹å¦‚ <code>inline code</code> å’Œä»£ç å—ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">main</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">&quot;Hello world!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Tips: ä½¿ç”¨<code>Mod-Enter</code>æ¥é€€å‡ºå—çº§å…ƒç´ ï¼Œä¾‹å¦‚ä»£ç å—ã€‚</p>
</blockquote>
<hr>
<p>ä½ å¯ä»¥è¾“å…¥<code>||</code>å’Œä¸€ä¸ªç©ºæ ¼æ¥åˆ›å»ºè¡¨æ ¼ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:left">è¡¨å¤´ 1</th>
<th style="text-align:center">è¡¨å¤´ 2</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">å†…å®¹ 1</td>
<td style="text-align:center"><s>å†…å®¹ 1</s></td>
</tr>
<tr>
<td style="text-align:left">å†…å®¹ 2</td>
<td style="text-align:center"><strong>å†…å®¹</strong> 2</td>
</tr>
</tbody>
</table>
<hr>
<p>æ•°å­¦å…¬å¼é€šè¿‡ <a href="https://en.wikipedia.org/wiki/TeX">TeX è¡¨è¾¾å¼</a>æ”¯æŒã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬æœ‰è¡Œå†…å…¬å¼ï¼š $E = mc^2$ï¼Œä½ å¯ä»¥ç‚¹å‡»å¹¶ç¼–è¾‘å®ƒã€‚</p>
<p>æ•°å­¦å…¬å¼å—ä¹Ÿæ˜¯æ”¯æŒçš„ã€‚</p>
<p>$$<br>
\begin{aligned}<br>
T( (v_1 + v_2) \otimes w) &amp;= T(v_1 \otimes w) + T(v_2 \otimes w) \<br>
T( v \otimes (w_1 + w_2)) &amp;= T(v \otimes w_1) + T(v \otimes w_2) \<br>
T( (\alpha v) \otimes w ) &amp;= T( \alpha ( v \otimes w) ) \<br>
T( v \otimes (\alpha w) ) &amp;= T( \alpha ( v \otimes w) ) \<br>
\end{aligned}<br>
$$</p>
<p>ä½ å¯ä»¥è¾“å…¥<code>$$</code>å’Œä¸€ä¸ªç©ºæ ¼æ¥åˆ›å»ºæ•°å­¦å…¬å¼å—ã€‚</p>
<hr>
<p>ä½¿ç”¨ <a href="https://www.webfx.com/tools/emoji-cheat-sheet/">emoji å¿«æ·æŒ‡ä»¤</a> ä¾‹å¦‚ <code>:+1:</code> æ¥æ·»åŠ  emoji.</p>
<p>åœ¨è¾“å…¥æ—¶ï¼Œä½ ä¹Ÿè®¸æ³¨æ„åˆ°äº† emoji è¿‡æ»¤å™¨ï¼Œå°è¯•è¾“å…¥<code>:baby</code>æ¥æŸ¥çœ‹å®ƒã€‚</p>
<hr>
<p>ä½ å¯ä»¥è¾“å…¥ <code>```mermaid</code> æ¥æ·»åŠ å›¾è¡¨ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">graph TD;</span><br><span class="line">    EditorState--&gt;EditorView;</span><br><span class="line">    EditorView--&gt;DOMEvent;</span><br><span class="line">    DOMEvent--&gt;Transaction;</span><br><span class="line">    Transaction--&gt;EditorState;</span><br></pre></td></tr></table></figure>
<hr>
<p>Wetabç¬”è®°åŸºäº <a href="https://milkdown.dev/">Milkdown</a> å®Œæˆ</p>
]]></content>
      <tags>
        <tag>Markdown</tag>
      </tags>
  </entry>
  <entry>
    <title>è¿‡æ»¤å™¨Filter</title>
    <url>/post/31fabe4c.html</url>
    <content><![CDATA[<h3 id="Filter">Filter</h3>
<h4 id="filter-æµç¨‹">filter æµç¨‹</h4>
<p><img src="https://www.yuque.com/api/filetransfer/images?url=https%3A%2F%2Fspring.hhui.top%2Fspring-blog%2Fimgs%2F190323%2F00.jpg&amp;sign=dbe2eb02c85bcb96cd3078214dbf49d629aed33c3fd6cf8aff8a4839d5e2dabf" alt="img"></p>
<p>ä¸€ä¸ª http è¯·æ±‚è¿‡æ¥ä¹‹åï¼š</p>
<ul>
<li>é¦–å…ˆè¿›å…¥ filterï¼Œæ‰§è¡Œç›¸å…³ä¸šåŠ¡é€»è¾‘</li>
<li>è‹¥åˆ¤å®šé€šè¡Œï¼Œåˆ™è¿›å…¥ Servlet é€»è¾‘ï¼ŒServlet æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œåˆè¿”å› Filterï¼Œæœ€ååœ¨è¿”å›ç»™è¯·æ±‚æ–¹</li>
<li>åˆ¤å®šå¤±è´¥ï¼Œç›´æ¥è¿”å›ï¼Œä¸éœ€è¦å°†è¯·æ±‚å‘ç»™ Servlet</li>
</ul>
<h4 id="åº”ç”¨åœºæ™¯">åº”ç”¨åœºæ™¯</h4>
<ul>
<li>åœ¨ filter å±‚ï¼Œè·å–ç”¨æˆ·çš„èº«ä»½</li>
<li>å¯ä»¥è€ƒè™‘åœ¨ filter å±‚åšä¸€äº›å¸¸è§„çš„æ ¡éªŒ (å¦‚å‚æ•°æ ¡éªŒï¼Œreferer æ ¡éªŒã€æƒé™æ§åˆ¶ç­‰)</li>
<li>å¯ä»¥åœ¨ filter å±‚åšè¿ç»´ã€å®‰å…¨é˜²æŠ¤ç›¸å…³çš„å·¥ä½œ(å¦‚å…¨é“¾è·¯æ‰“ç‚¹ï¼Œå¯ä»¥åœ¨ flter å±‚åˆ†é…ä¸€ä¸ª traceld;ä¹Ÿå¯ä»¥åœ¨è¿™ä¸€å±‚åšé™æµç­‰)</li>
</ul>
<h4 id="ä½¿ç”¨">ä½¿ç”¨</h4>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Slf4j</span><br><span class="line">@WebFilter(urlPatterns = &quot;/*&quot;, filterName = &quot;reqRecordFilter&quot;, asyncSupported = true)</span><br><span class="line">public class ReqRecordFilter implements Filter &#123;</span><br><span class="line">    private static Logger REQ_LOG = LoggerFactory.getLogger(&quot;req&quot;);</span><br><span class="line">    /**</span><br><span class="line">     * è¿”å›ç»™å‰ç«¯çš„traceIdï¼Œç”¨äºæ—¥å¿—è¿½è¸ª</span><br><span class="line">     */</span><br><span class="line">    private static final String GLOBAL_TRACE_ID_HEADER = &quot;g-trace-id&quot;;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private GlobalInitService globalInitService;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private StatisticsSettingService statisticsSettingService;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void init(FilterConfig filterConfig) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException &#123;</span><br><span class="line">        long start = System.currentTimeMillis();</span><br><span class="line">        HttpServletRequest request = null;</span><br><span class="line">        try &#123;</span><br><span class="line">            request = this.initReqInfo((HttpServletRequest) servletRequest, (HttpServletResponse) servletResponse);</span><br><span class="line">            CrossUtil.buildCors(request, (HttpServletResponse) servletResponse);</span><br><span class="line">            filterChain.doFilter(request, servletResponse);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            buildRequestLog(ReqInfoContext.getReqInfo(), request, System.currentTimeMillis() - start);</span><br><span class="line">            // ä¸€ä¸ªé“¾è·¯è¯·æ±‚å®Œæ¯•ï¼Œæ¸…ç©ºMDCç›¸å…³çš„å˜é‡(å¦‚GlobalTraceIdï¼Œç”¨æˆ·ä¿¡æ¯)</span><br><span class="line">            MdcUtil.clear();</span><br><span class="line">            ReqInfoContext.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  	@Override</span><br><span class="line">    public void destroy() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  	# ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>initï¼šåˆå§‹åŒ–æ—¶æ‰§è¡Œ</p>
</li>
<li>
<p>destoryï¼š é”€æ¯æ—¶æ‰§è¡Œ</p>
</li>
<li>
<p>doFilterï¼šfilter è§„åˆ™å‘½ä¸­çš„è¯·æ±‚ï¼Œéƒ½ä¼šèµ°è¿›æ¥</p>
</li>
<li>
<ul>
<li>ä¸‰ä¸ªå‚æ•°ï¼Œæ³¨æ„ç¬¬ä¸‰ä¸ª FilterChainï¼Œè¿™é‡Œæ˜¯ç»å…¸çš„è´£ä»»é“¾è®¾è®¡æ¨¡å¼</li>
<li>æ‰§è¡Œ filterChain.doFilter(servletRequestï¼ŒservletResponse) è¡¨ç¤ºä¼šç»§ç»­å°†è¯·æ±‚æ‰§è¡Œä¸‹å»è‹¥ä¸æ‰§è¡Œè¿™ä¸€å¥ï¼Œè¡¨ç¤ºè¿™ä¸€æ¬¡çš„ http è¯·æ±‚åˆ°æ­¤ä¸ºæ­¢äº†ï¼Œåé¢çš„èµ°ä¸ä¸‹å»äº†</li>
</ul>
</li>
</ul>
<h4 id="æ³¨å†Œï¼ˆè¿‡æ»¤å™¨Filteræ³¨å†Œåˆ°Springå®¹å™¨ï¼‰">æ³¨å†Œï¼ˆè¿‡æ»¤å™¨Filteræ³¨å†Œåˆ°Springå®¹å™¨ï¼‰</h4>
<ol>
<li>ä½¿ç”¨ @WebFilter æ³¨è§£ï¼Œæ ‡æ³¨åˆ°è‡ªå·±å®ç°çš„è¿‡æ»¤å™¨ä¸Š</li>
</ol>
<p>WebFilter å¸¸ç”¨å±æ€§å¦‚ä¸‹ï¼Œå…¶ä¸­ urIPatterns æœ€ä¸ºå¸¸ç”¨ï¼Œè¡¨ç¤ºè¿™ä¸ª flter é€‚ç”¨äºå“ªäº› url è¯·æ±‚(é»˜è®¤åœºæ™¯ä¸‹å…¨éƒ¨è¯·æ±‚éƒ½è¢«æ‹¦æˆª)</p>
<table>
<thead>
<tr>
<th>å±æ€§</th>
<th>ç±»å‹</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>fileName</td>
<td>String</td>
<td>æŒ‡å®šè¿‡æ»¤å™¨çš„ name å±æ€§ï¼Œç­‰ä»·äº <filter-name>ã€‚</td>
</tr>
<tr>
<td>value</td>
<td>String[]</td>
<td>è¯¥å±æ€§ç­‰ä»·äº urlPatterns å±æ€§ï¼Œä½†æ˜¯ä¸¤è€…ä¸åº”åŒæ—¶ä½¿ç”¨ã€‚</td>
</tr>
<tr>
<td>urlPatterns</td>
<td>String[]</td>
<td>æŒ‡å®šä¸€ç»„è¿‡æ»¤å™¨çš„URLåŒ¹é…æ¨¡å¼ã€‚ç­‰ä»·äº<url-pattern>æ ‡ç­¾ã€‚</td>
</tr>
<tr>
<td>srvletNames</td>
<td>String[]</td>
<td>æŒ‡å®šè¿‡æ»¤å™¨å°†åº”ç”¨äºå“ªäº›Servletã€‚å–å€¼æ˜¯ @WebSerlvet ä¸­çš„nameå±æ€§çš„å–å€¼ï¼Œæˆ–è€…æ˜¯web.xmlä¸­çš„<servlet-name>çš„å–å€¼ã€‚</td>
</tr>
<tr>
<td>dispatcherTypes</td>
<td>DispatcherType</td>
<td>æŒ‡å®šè¿‡æ»¤å™¨çš„è½¬å‘æ¨¡å¼ï¼Œå…·ä½“å–å€¼åŒ…æ‹¬ï¼šASYNC/ERROR/FORWARD/INCLUDE/REQUEST.</td>
</tr>
<tr>
<td>initParams</td>
<td>WebinitParam[]</td>
<td>æŒ‡å®šä¸€ç»„è¿‡æ»¤å™¨åˆå§‹åŒ–å‚æ•°ï¼Œç­‰ä»·äº<init-param>æ ‡ç­¾ã€‚</td>
</tr>
<tr>
<td>asyncSupported</td>
<td>boolean</td>
<td>å£°æ˜è¿‡æ»¤å™¨æ˜¯å¦æ”¯æŒå¼‚æ­¥æ“ä½œæ¨¡å¼ï¼Œç­‰ä»·äº<async-supported>æ ‡ç­¾ã€‚</td>
</tr>
<tr>
<td>description</td>
<td>String</td>
<td>è¯¥è¿‡æ»¤å™¨çš„æè¿°ä¿¡æ¯ï¼Œç­‰ä»·äº<description>æ ‡ç­¾ã€‚</td>
</tr>
<tr>
<td>displayName</td>
<td>String</td>
<td>è¯¥è¿‡æ»¤å™¨çš„æ˜¾ç¤ºåï¼Œé€šå¸¸é…åˆå·¥å…·ä½¿ç”¨ï¼Œç­‰ä»·äº <display-name> æ ‡ç­¾</td>
</tr>
</tbody>
</table>
<p>ä½¿ç”¨è¿™ä¸ªæ³¨è§£æ—¶ï¼Œè¯·æ³¨æ„ï¼Œéœ€è¦åœ¨<strong>å¯åŠ¨ç±»/é…ç½®ç±»</strong>ä¸Šæ·»åŠ  <strong>ServletComponentScan</strong> æ³¨è§£æ¥å¯ç”¨.</p>
<p><strong>æ³¨æ„ç‚¹1</strong>ï¼š@WebFilter æ³¨è§£ç»“åˆ@Order æ¥å®šä¹‰ filter æ³¨è§£ï¼Œå¯èƒ½å¹¶ä¸ä¼šç”Ÿæ•ˆã€‚</p>
<p><strong>æ³¨æ„ç‚¹2</strong>ï¼š@WebFilter å£°æ˜çš„Filterï¼Œä¼˜å…ˆçº§ä¸º 2147483647 (æœ€ä½ä¼˜å…ˆçº§ï¼‰ã€‚</p>
<ol start="2">
<li>FilterRegistrationBean</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Bean</span><br><span class="line">public FilterRegistrationBean&lt;Filter&gt; orderFilter() &#123;</span><br><span class="line">		FilterRegistrationBean&lt;Filter&gt; filter = new FilterRegistrationBean&lt;&gt;();</span><br><span class="line">		filter.setName(&quot;regRecordFilter&quot;);</span><br><span class="line">		filter.seturlPatterns(Arrays.asList(&quot;/**&quot;));</span><br><span class="line">		filter.setFilter(new RegRecordFilter());  //æŒ‡å®šä¼˜å…ˆçº§</span><br><span class="line">		filter.setorder(-1);</span><br><span class="line">		return filter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="å®ä¾‹">å®ä¾‹</h4>
<p>æŠ€æœ¯æ´¾ä¸­ï¼ŒFilter åº”ç”¨åˆ°äº†ä»¥ä¸‹å‡ ä¸ªåœ°æ–¹:</p>
<ul>
<li>èº«ä»½è¯†åˆ«ï¼Œå¹¶ä¿å­˜èº«ä»½åˆ° RegInfoContext ä¸Šä¸‹æ–‡ä¸­ã€‚è¯¦æƒ…åšæ–‡: <a href="https://www.yuque.com/itwanger/az7yww/yk1x4v6wt5gz103q">https://www.yuque.com/itwanger/az7yww/yk1x4v6wt5gz103q</a></li>
<li>è®°å½•è¯·æ±‚è®°å½•ï¼Œè¯¦æƒ…åšæ–‡: <a href="https://www.yuque.com/itwanger/az7yww/wb3pz26699c86nuz">https://www.yuque.com/itwanger/az7yww/wb3pz26699c86nuz</a></li>
<li>æ·»åŠ è·¨åŸŸæ”¯æŒï¼Œè¯¦æƒ…åšæ–‡: <a href="https://www.yuque.com/itwanger/az7yww/pznv1robndgbuyhh">https://www.yuque.com/itwanger/az7yww/pznv1robndgbuyhh</a></li>
</ul>
<h4 id="filter-åœ¨æŠ€æœ¯æ´¾ä¸­çš„åº”ç”¨æ€»ç»“">filter åœ¨æŠ€æœ¯æ´¾ä¸­çš„åº”ç”¨æ€»ç»“</h4>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/35904594/1693227389336-59e1e8c1-aa85-450d-911d-2e4dacffadbb.png" alt="img"></p>
<h4 id="æœ€å">æœ€å</h4>
<p><a href="https://github.com/itwanger/paicoding">æŠ€æœ¯æ´¾é¡¹ç›®åœ°å€</a></p>
]]></content>
      <categories>
        <category>coding</category>
        <category>web</category>
      </categories>
      <tags>
        <tag>web</tag>
      </tags>
  </entry>
  <entry>
    <title>ç¦»äºº</title>
    <url>/post/14e24de8.html</url>
    <content><![CDATA[<h2 id="1">1</h2>
<p>ä¸æ‡‚äº‹çš„è€å°å­©ï¼Œå®¶é‡Œäººéƒ½ä¸å…³æ³¨çš„ç¬¨è›‹ï¼Œå¿˜äº†ç»™è‡ªå®¶å­™å­ä¸Šæˆ·å£çš„ç”Ÿäº§é˜Ÿé˜Ÿé•¿ï¼Œæ‹¿è‡ªå·±å„¿å­åå­—è´·æ¬¾ç»™é˜Ÿé‡Œçš„å·¥ç¨‹çš„è€ä¸ä¿®ï¼Œâ€œäººç©·æ°´éƒ½ç©·â€è¿ä¸ªå­™å¨ƒå­éƒ½æ”¶æ‹¾ä¸å¹²å‡€çš„è€å¤´â€”â€”ä»¥ä¸Šï¼Œå°±æ˜¯å¤šå¹´ä»¥åè¿˜ç•™åœ¨æˆ‘è„‘æµ·ä¸­å…³äºçˆ·çˆ·çš„å…¨éƒ¨å°è±¡äº†ã€‚</p>
<p>è¿˜è®°å¾—é‚£ä¸ªä¸‰å¹´çº§çš„åˆåï¼Œå¤–å©†æ¥å­¦æ ¡æ¥æˆ‘ï¼Œè¯´å¸¦æˆ‘å»çœ‹çˆ·çˆ·ï¼Œæˆ‘æ‡µæ‡µæ‡‚æ‡‚åœ°è·Ÿç€å»äº†ï¼Œçœ‹å®Œäº†ï¼Œæ‡µæ‡µæ‡‚æ‡‚åœ°èµ°äº†ï¼Œå“¦ï¼ŒåŸæ¥æ˜¯çˆ·çˆ·å¸®äººæ’ç§§çš„æ—¶å€™æ™•å€’äº†ï¼Œæ²¡æŠ¢æ•‘å›æ¥ï¼Œäºæ˜¯ï¼Œæˆ‘å¾ˆè‡ªç„¶çš„æ¥å—äº†è¿™æ ·ä¸€ä¸ªäº‹å®â€”â€”çˆ·çˆ·æ­»äº†ï¼Œé‚£ä¸ªç¼–äº†ä¸€å¤©çš„ç«¹ç¯¾æ‹¿å»æ¢ç‚¹é’±ç»™å°å­™å­ä¹°é¥®æ–™çš„è€å¤´æ­»äº†ã€‚</p>
<p>å› ä¸ºå®¶åº­çš„åŸå› ï¼Œæˆ‘ä»å¾ˆå°çš„æ—¶å€™å°±ä¸€ç›´æ˜¯è·Ÿç€å¤–å…¬å¤–å©†å®¶ä¸€èµ·ç”Ÿæ´»çš„ï¼Œå¯¹äºè¿™ä¸ªçˆ·çˆ·ï¼Œäº†è§£ä¹Ÿå°±ååˆ†æœ‰é™ã€‚å€’ä¸å¦‚è¯´ï¼Œå…³äºä»–çš„å¾ˆå¤šäº‹ï¼Œå¾ˆå¤šå°è±¡ï¼Œå…¨æ˜¯ä»å¤–å…¬å¤–å©†å’Œçˆ¸å¦ˆå£ä¸­å¬æ¥ï¼Œæœ€åè‡ªè¡Œæ‹¼æ¥è€Œæˆçš„ã€‚æ¯é€¢è¿‡å¹´ï¼Œéƒ½æ˜¯å¿…é¡»è¦è¦å»ä¸ŠåŸçš„ï¼Œåœ¨è¿™ä¸ªæ—¶å€™ï¼Œå¬ä¸€å¬çˆ¸å¦ˆè®²è®²ä»–è¿‡å»çš„äº‹ï¼Œå¬ä¸€å¬çˆ¸å¦ˆç»™ä»–è®²ä»–èµ°ä¹‹åä»–å„¿å­™çš„äº‹ï¼Œå†ç¥ˆæ„¿è€äººå®¶åœ¨å¤©ä¹‹çµç»™ç°ä¸–çš„äººä¿ä½‘ï¼Œåœ¨é¦™èœ¡é’±çº¸ç‡ƒçƒ§çš„ç«å…‰ä¸­ã€åœ¨å™¼é‡Œå•ªå•¦çš„é­ç‚®å£°ä¸­ï¼Œä»£é™…é—´çš„ä¼ æ‰¿å°±å°±ä»¥è¿™æ ·çš„å½¢å¼å®Œæˆäº†ã€‚</p>
<h2 id="2">2</h2>
<p>å¹´é¾„å’Œè„¾æ°”ä¹‹é—´è‚¯å®šæ˜¯æœ‰ä¸€å®šå…³ç³»çš„ï¼Œæ— ä»–ï¼Œä»æˆ‘è‡ªå·±çš„ç»éªŒæ¥çœ‹å°±æ˜¯è¿™æ ·ï¼Œä»æˆ‘èº«è¾¹çš„äººå˜åŒ–æ¥çœ‹ä¹Ÿæ˜¯è¿™æ ·ã€‚</p>
<p>å°å­¦çš„æ—¶å€™å§ï¼Œæˆ‘çš„é‚»å±…å®¶æœ‰ä¸ªå¹´é¾„å¾ˆå¤§çš„è€å¤ªå¤ªï¼Œå¥¹å®¶å…»äº†ä¸€æ¡è€æ¯ç‹—ï¼Œå¾ˆå‡¶ï¼ŒçœŸçš„å¾ˆå‡¶ï¼Œæ¯å¤©æˆ‘å»ä¸Šå­¦ä»ä»–å®¶é—¨å£ç»è¿‡éƒ½å¿ƒæƒŠè‚‰è·³ï¼Œèµ°çš„æ¬¡æ•°å¤šäº†ï¼Œæœ€åè¿˜æ˜¯æ²¡èº²è¿‡è¢«å’¬äº†ä¸€å›ï¼Œå› æ­¤ï¼Œæˆ‘å¯¹è€å¤ªå¤ªå°è±¡ä¹Ÿéå¸¸ä¸å¥½ã€‚</p>
<p>é‚£ä¸€å¹´ï¼Œè€å¤ªå¤ªå®¶çš„æ‡æ·æ ‘ç»“æœäº†ï¼Œå¾ˆå¤šå¾ˆå¤§ï¼Œæˆ‘å¾ˆé¦‹ï¼Œé¦‹ä½†æ˜¯ä¸æ•¢ã€‚åæ¥ï¼Œè€å¤ªå¤ªå«æˆ‘è‡ªå·±ä¸Šæ ‘å»æ‘˜å°±æ˜¯äº†ï¼Œå°å­©å­å“ªèƒ½å—å¾—äº†é¼“åŠ±ï¼Œååœ¨æ ‘ä¸Šå°±å¼€å§‹ä¸€é¡¿åƒã€‚å¤–å…¬åˆšå¹²å®Œæ´»å›æ¥ï¼Œè§æˆ‘ååœ¨é‚»å±…å®¶çš„æ‡æ·æ ‘ä¸Šå¤§åƒï¼Œå¾ˆç”Ÿæ°”åœ°å«æˆ‘ä¸‹æ¥ï¼Œæˆ‘æ²¡ç†ä»–ï¼Œæ²¡æƒ³åˆ°ç«Ÿç„¶æ‰”å°çŸ³å­è¿‡æ¥ï¼Œäºæ˜¯ï¼Œæˆ‘å¤§å“­ç€å›å®¶äº†ã€‚å¤–å©†å›æ¥ï¼ŒçŸ¥é“äº†æƒ…å†µï¼ŒæŠ„èµ·äºŒæŒ‡å®½çš„ç¯¾æ¡å°±æœå¤–å…¬èº«ä¸Šæ‰“å»ï¼Œä¸€è¾¹æ‰“ä¸€ééª‚ï¼Œâ€œå“ªæœ‰ä½ è¿™æ ·æ•™è‚²å¨ƒå¨ƒçš„ï¼Œé‚£æ˜¯æ‹¿çŸ³å¤´æ‰“çš„å—ï¼Œä¸æ™“å¾—è½»é‡ï¼Œä½ çœ‹æˆ‘ä»Šå¤©æ‰“ä¸æ‰“å¾—ä½ å¥½çœ‹â€ã€‚</p>
<p>æš´èºï¼Œä¸çŸ¥è½»é‡ï¼Œå¤§æ¦‚å°±æ˜¯é‚£æ—¶å€™å¤–å…¬çš„è„¾æ°”äº†ã€‚</p>
<p>ä¸Šé«˜ä¸­äº†ï¼Œæˆ‘è¿æ°”å¥½ï¼Œåœ¨åŒå­¦çš„æ¨èä¸‹å¾—åˆ°äº†å¸‚é«˜ä¸­çš„é’çï¼Œåˆ†æ•°ä¸Šçº¿å°±è¦ï¼Œå…å­¦æ‚è´¹ã€‚å½“æ—¶ä¹Ÿæ²¡æœ‰æœˆå‡ä¸€è¯´ï¼Œæ³•å®šå‡æœŸä¸­æ—¶é—´é•¿ç‚¹çš„æ‰èƒ½å›å®¶ï¼Œäºæ˜¯ï¼Œå›å®¶çš„æ¬¡æ•°å°±è¿™æ ·å˜å°‘äº†ã€‚å¥‡æ€ªçš„æ˜¯ï¼Œæˆ‘è·Ÿå¤–å…¬è¿™ä¸ªè€å¤´çš„å…³ç³»å€’æ˜¯è«åå…¶å¦™å¥½äº†å¾ˆå¤šï¼Œå¥½åƒå‡ å¤©ä¸è§è¿™ä¸ªäººå°±è¤ªå»äº†å¾€æ—¥çš„æš´èºï¼Œè½¬èº«æ‹¥æŠ±äº†ç›¸åçš„å¹³å’Œã€‚å®¶é‡Œçš„æ‰“ç±³æœºä¸å¥½ç”¨äº†ï¼Œä¸€çœ‹æ˜¯ç­›å­åäº†ï¼Œè¡Œï¼Œä½ å°å­å»è¡—ä¸Šä¹°ä¸€å¼ å›æ¥å§ï¼›ä»Šå¤©è¦æŠ½æ°´å»çŒé‚£ç‰‡èŠ±ç”Ÿåœ°ï¼Œèµ°å§ï¼Œå’±çˆ·ä¿©ä¸€å—æŠŠæ°´ç®¡å’Œæ°´æ³µæ‰›è¿‡å»ï¼›è¯»äº†å‡ å¤©ä¹¦æ‰‹è„šä¹Ÿæ²¡å˜æ…¢å˜›ï¼Œè¿˜é˜”ä»¥ï¼Œä»Šå¤©å°±æŠŠè¿™ç‰‡è°·å­æ‰“å®Œäº†ï¼›â€œäººæ°‘æ¸ å˜›ï¼Œè¿˜æ˜¯æˆ‘åˆ‡ä¿®çš„ï¼Œå½“æ—¶æ¯›è€æ±‰â€¦â€¦â€ï¼›â€œå—¯ï¼Œä¸œè¥¿æ‹¿é½æ²¡å¾—ï¼Œæ­¦æ±‰ä¹Ÿæ²¡å¾—å¥½è¿œå˜›ï¼Œå½“å¹´æˆ‘ä¹Ÿæ˜¯åˆ‡è¿‡é‚£è¾¹äº†ï¼Œä½ åˆ‡äº†å¥½ç”Ÿå­¦ä¹ å“ˆï¼Œä¸Šå¤§å­¦äº†ä¹Ÿä¸æ˜¯ç»™ä½ æ”¾æ¾çš„ï¼Œå—¯ï¼Œå±‹å¤´æˆ‘æ™“å¾—ï¼Œä½ èµ°å˜›â€â€¦â€¦</p>
<p>å¹³å’Œï¼Œå®é™ï¼Œåƒä¸€å›è€é…’ï¼Œè¿™æ˜¯é‚£æ—¶å€™å¤–å…¬çš„è„¾æ°”ã€‚</p>
<h2 id="3">3</h2>
<p>ä¸€æ™ƒåˆæ˜¯å‡ å¹´ï¼Œå¥½ä¼¼æˆ‘ä»æœªè®¤çœŸçœ‹è¿‡å¤–å…¬è¿™ä¸ªè€å¤´ä¸€æ ·ï¼Œä»–æ€ä¹ˆä¸€ä¸‹å­è¿™ä¹ˆç˜¦å¼±äº†ï¼Œå¼¯è…°é©¼èƒŒçš„äº†ï¼Œçœ¼ç¥æ²¡æœ‰å¾€æ—¥çš„çŠ€åˆ©ï¼Œå˜´è§’å´å«ç€ä¼¼æœ‰è‹¥æ— çš„ç¬‘æ„ï¼Œåƒæ‘é‡Œé‚£å£è€äº•ï¼Œè®°å½•äº†ä¸€åˆ‡ä½†æ˜¯åˆå°†å…¶æ·±æ·±åŸ‹åœ¨æ°´åº•ï¼Œå‡ æ— äººå¯è§¦è¾¾ã€‚</p>
<p>å‰ä¸ä¹…çˆ¸æ‰“ç”µè¯ç»™æˆ‘ï¼Œå‘Šè¯‰æˆ‘å¤–å…¬ç¡®è¯Šäº†èƒƒç™Œï¼Œå«æˆ‘ç»™å®¶é‡Œæ‰“ä¸ªç”µè¯å¥½æ­¹é—®ä¸€ä¸‹ï¼Œä½†æ˜¯æˆ‘ä¸€ç›´ä¸æ•¢å¾€å®¶é‡Œæ‰“ç”µè¯ï¼Œæˆ‘åœ¨å®³æ€•ï¼Œåœ¨é€ƒé¿ï¼Œå®³æ€•è‡ªå·±è¾œè´Ÿä»–ä»¬çš„æœŸå¾…ï¼Œå®³æ€•çœ‹è§ä»–ä»¬çš„çœ¼ç¥ï¼Œå®³æ€•å¬è§ä»–ä»¬çš„å£°éŸ³ï¼Œæˆ‘åœ¨é€ƒé¿è‡ªå·±çš„è´£ä»»ï¼Œä½†æ˜¯æˆ‘åˆè¿˜èƒ½å†èº²å¤šä¹…å‘¢ï¼Ÿ</p>
<p>æ›¾ç»æˆ‘å¯¹çš®åŒ…éª¨å¤´è¿™ä¸ªè¯çš„å°è±¡åªåœç•™åœ¨å­—å…¸é‡Œï¼Œç›´åˆ°æˆ‘å†è§åˆ°æˆ‘çš„å¤–å…¬ï¼Œé‚£æ˜¯æ€æ ·çš„ä¸€å‰¯å…‰æ™¯ï¼Ÿæ›¾ç»åŠ›æ‹…åƒæ–¤çš„è‚Œè‚‰å†æ²¡æœ‰ä¸€ä¸ä¸€æ¯«ç•™å­˜åœ¨è¿™ä¸ªè€äººèº«ä¸Šï¼Œè‚‹éª¨å‹¾å‹’å‡ºçš„èƒ¸è†›å°±è¿™æ ·æ¯«æ— é®æ©åœ°å±•ç°ç€ï¼ŒåŒå¼¯æ›²çš„è„Šæ¢éª¨ä¸€èµ·ç‹°ç‹åœ°å±•ç¤ºç€æ—¶é—´çš„ä¼ŸåŠ›ï¼Œå±•ç¤ºç€â€œç—…â€è¿™ä¸€äººä¸–é—´å¤§è‹¦æ¥šçš„å¨åŠ›ï¼Œçœ‰å¤´è½»è¹™çš„æ ·å­åƒæ˜¯åœ¨å¿å—ç€æ— æ—¶æ— åˆ»ä¸åœ¨çš„ç—›æ¥šï¼Œæˆ‘ç®€ç›´ä¸å¿å†çœ‹ã€‚é¢å¯¹ç€è¿™ä¸€åˆ‡ï¼Œæˆ‘æ— è¯å¯è¯´ï¼Œæˆ‘æ— èƒ½ä¸ºåŠ›ï¼Œä¸–ä¸Šéš¾é“è¿˜æœ‰ä»€ä¹ˆä¸œè¥¿èƒ½å†æ¢å›è¿™ä¸ªè€äººçš„æ—¶å…‰å—ï¼Ÿ</p>
<p>æ ‘æ¬²é™è€Œé£ä¸æ­¢ï¼Œå­æ¬²å…»è€Œäº²ä¸å¾…ã€‚åˆé—»ä¸è¯†æ›²ä¸­æ„ï¼Œå†å¬å·²æ˜¯æ›²ä¸­äººã€‚ç½¢ï¼Œçæƒœçœ¼å‰äººå§ã€‚</p>
<h2 id="end">end</h2>
<p>â€œçœŸæ²¡æƒ³åˆ°æˆ‘ä»¬åœ¨è¿™æ ·ä¸€ä¸ªåœ°æ–¹å‘Šåˆ«ï¼Œä½†æ˜¯è·Ÿäººå‘Šåˆ«çš„æ—¶å€™ï¼Œè¿˜æ˜¯è¦ç”¨åŠ›ä¸€ç‚¹ï¼Œå› ä¸ºä½ å¤šè¯´ä¸€å¥ï¼Œè¯´ä¸å®šå°±æ˜¯æœ€åä¸€å¥ï¼Œå¤šçœ‹ä¸€çœ¼ï¼Œå¼„ä¸å¥½å°±æ˜¯æœ€åä¸€çœ¼ã€‚â€â€”â€”ã€Šåä¼šæ— æœŸã€‹</p>
]]></content>
      <categories>
        <category>Life</category>
      </categories>
      <tags>
        <tag>éšæƒ³</tag>
      </tags>
  </entry>
</search>
